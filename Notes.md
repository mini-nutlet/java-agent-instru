**1. Java Agent æ˜¯ä»€ä¹ˆï¼Ÿ**

- Java Agent æ˜¯åœ¨ Java å¯åŠ¨æ—¶æˆ–è¿è¡Œæ—¶æ’å…¥çš„ä»£ç ï¼Œå…è®¸æˆ‘ä»¬åœ¨ class è¢«åŠ è½½å‰ä¿®æ”¹å®ƒã€‚
- æ ¸å¿ƒæœºåˆ¶åŸºäº `java.lang.instrument.Instrumentation` æ¥å£ã€‚

**å…³é”®è¯ï¼š**

- `premain(String args, Instrumentation inst)`ï¼šJVM å¯åŠ¨æ—¶è°ƒç”¨
- `agentmain(String args, Instrumentation inst)`ï¼šJVM è¿è¡Œæ—¶åŠ¨æ€ attach æ—¶è°ƒç”¨ï¼ˆå¦‚ä½¿ç”¨ JConsoleï¼‰



**2. Instrumentation çš„ä½œç”¨**

- å¯ä»¥åœ¨ç±»åŠ è½½å‰è¿›è¡Œ class å­—èŠ‚ç ä¿®æ”¹ï¼ˆå…¸å‹ç”¨é€”ï¼šæ€§èƒ½ç›‘æ§ã€æ—¥å¿—åŸ‹ç‚¹ã€AOPï¼‰
- å¸¸ä¸ **å­—èŠ‚ç å·¥å…·åº“** é…åˆä½¿ç”¨ï¼šå¦‚ ASMã€Javassistã€ByteBuddy



è¿›é˜¶å»ºè®®ï¼š

ä½¿ç”¨ **ByteBuddy**ï¼šæ›´æ˜“ç”¨çš„å­—èŠ‚ç ä¿®æ”¹å·¥å…·

äº†è§£ **Attach API**ï¼šåœ¨ç¨‹åºè¿è¡Œä¸­åŠ¨æ€åŠ è½½ agent

ç”¨ agent åšä¸€ä¸ª â€œæ–¹æ³•è€—æ—¶ç›‘æ§å™¨â€



Java å®˜æ–¹æ–‡æ¡£ï¼šhttps://docs.oracle.com/javase/8/docs/api/java/lang/instrument/package-summary.html

ByteBuddy é¡¹ç›®ï¼šhttps://bytebuddy.net



## ä¸€ã€Java Agent çš„å‘å±•èƒŒæ™¯

### ğŸ§© èƒŒååŠ¨å› 

Java Agent æ˜¯ **JVM æ’æ¡©æœºåˆ¶ï¼ˆInstrumentationï¼‰** çš„äº§ç‰©ï¼Œå®ƒèµ·åˆæ˜¯ä¸ºäº† **æ€§èƒ½ç›‘æ§å’Œæ•…éšœè¯Šæ–­å·¥å…·** çš„éœ€è¦è€Œå¼•å…¥çš„ã€‚ä¾‹å¦‚ï¼š

- **JVM éœ€è¦æ”¯æŒè¿è¡Œæ—¶ç›‘æ§è€Œä¸ä¾µå…¥ä¸šåŠ¡ä»£ç **
- å¼€å‘è€…å¸Œæœ›åœ¨ä¸æ”¹åŠ¨æºç çš„æƒ…å†µä¸‹ï¼Œè§‚å¯Ÿç¨‹åºè¿è¡ŒçŠ¶æ€ï¼ˆå¦‚æ–¹æ³•è€—æ—¶ã€å¯¹è±¡åˆ†é…ã€ç±»åŠ è½½ç­‰ï¼‰

### ğŸ•°ï¸å‘å±•å†ç¨‹

| Java ç‰ˆæœ¬ | å¼•å…¥å†…å®¹                                                     |
| --------- | ------------------------------------------------------------ |
| Java 1.5  | å¼•å…¥ `java.lang.instrument.*` åŒ…ï¼Œæ”¯æŒ **premain Agent** å’Œ **ç±»åŠ è½½å‰å­—èŠ‚ç ä¿®æ”¹** |
| Java 6    | å¼•å…¥ `Attach API` å’Œ **agentmain** æœºåˆ¶ï¼Œå¯åœ¨ç¨‹åºè¿è¡Œæ—¶åŠ¨æ€ attach |
| Java 8+   | Instrumentation å˜å¾—æ›´ç¨³å®šï¼Œå·¥å…·é“¾ï¼ˆå¦‚ JFRã€VisualVMã€JProfilerï¼‰æ›´ä¸°å¯Œ |
| Java 11+  | æ›´å¼ºè°ƒå¯¹ JDK å·¥å…·çš„å¯è§‚æµ‹æ€§æ‰©å±•ï¼Œå¦‚ Flight Recorderï¼Œagent ç”¨äºé‡‡é›†æ›´å¤šæŒ‡æ ‡ |

------

## âš™ï¸ äºŒã€Java Agent çš„åŸºæœ¬åŸç†

Java Agent æ˜¯åˆ©ç”¨ **JVM åœ¨ç±»åŠ è½½å‰çš„é’©å­ç‚¹**ï¼Œè®©å¼€å‘è€…æœ‰æœºä¼šæ’å…¥è‡ªå·±çš„é€»è¾‘æ¥ä¿®æ”¹ç±»å®šä¹‰ï¼ˆå­—èŠ‚ç ï¼‰ï¼Œå…¶æœ¬è´¨æ˜¯å¯¹ class æ–‡ä»¶åšå­—èŠ‚çº§çš„â€œå¢å¼ºâ€æˆ–â€œç¯¡æ”¹â€ã€‚

### âœ³ï¸ ä¸¤ç§ä½¿ç”¨æ–¹å¼ï¼š

| æ–¹å¼        | å¯åŠ¨æ–¹å¼                | æ–¹æ³•å                               | è¯´æ˜                 |
| ----------- | ----------------------- | ------------------------------------ | -------------------- |
| é™æ€ä»£ç†    | `-javaagent:xxx.jar`    | `premain(String, Instrumentation)`   | åº”ç”¨å¯åŠ¨æ—¶åŠ è½½       |
| åŠ¨æ€ attach | ç¨‹åºè¿è¡Œå attach agent | `agentmain(String, Instrumentation)` | è¿è¡Œæ—¶åŠ¨æ€åŠ è½½ agent |

------

## ğŸ§° ä¸‰ã€å…¸å‹åº”ç”¨åœºæ™¯

### âœ… æ€§èƒ½ç›‘æ§ä¸åˆ†æ

- æ–¹æ³•è°ƒç”¨ç»Ÿè®¡ï¼ˆå¦‚ Prometheus + Agentï¼‰
- å†…å­˜ã€CPUã€GC ç›‘æ§ï¼ˆJVM Profilerï¼‰
- çƒ­ç‚¹ä»£ç åˆ†æï¼ˆå¦‚ JFR + agentï¼‰

### âœ… è‡ªåŠ¨åŸ‹ç‚¹ / é“¾è·¯è¿½è¸ª

- APM å·¥å…·ï¼ˆå¦‚ SkyWalking, Pinpoint, NewRelicï¼‰
- æ— ä¾µå…¥åœ°å®ç°æ—¥å¿—ã€è°ƒç”¨é“¾è·Ÿè¸ªï¼ˆRPCã€HTTPï¼‰

### âœ… å®‰å…¨æ‰«æ / æ’ä»¶æœºåˆ¶

- æ£€æŸ¥æ˜¯å¦ä½¿ç”¨äº†ç¦ç”¨ç±»ï¼ˆå¦‚ sun.misc.Unsafeï¼‰
- ä¸º SaaS åº”ç”¨æä¾›æ’ä»¶åŒ–èƒ½åŠ›

### âœ… åŠ¨æ€ç±»å¢å¼º / AOP æ¡†æ¶

- å’Œ ByteBuddyã€Javassist é…åˆï¼Œå®ç° AOP
- Mock æ¡†æ¶ä¸­çš„åŠ¨æ€ä»£ç†ï¼ˆå¦‚ Mockitoï¼‰

------

## ğŸ“¦ å››ã€æ ¸å¿ƒæ¥å£ä»‹ç»

### `java.lang.instrument.Instrumentation`

Java Agent çš„å…¥å£ï¼Œç”¨äºæ³¨å†Œ transformerï¼Œæ“ä½œ classï¼š

- `addTransformer(ClassFileTransformer transformer)`
- `retransformClasses(Class<?>... classes)`
- `getAllLoadedClasses()`
- `redefineClasses(...)` ï¼ˆé…åˆ `Can-Redefine-Classes: true`ï¼‰

### `ClassFileTransformer`

ç”¨äºå¯¹ç±»åŠ è½½å‰çš„å­—èŠ‚ç è¿›è¡Œæ‹¦æˆªå’Œä¿®æ”¹ï¼š

```
javaå¤åˆ¶ç¼–è¾‘byte[] transform(
  ClassLoader loader,
  String className,
  Class<?> classBeingRedefined,
  ProtectionDomain protectionDomain,
  byte[] classfileBuffer)
```

------

## ğŸ”¥ äº”ã€å¸¸è§å·¥å…·ç”Ÿæ€ï¼ˆä¾èµ– Java Agentï¼‰

| å·¥å…·                  | åŠŸèƒ½                     | æ˜¯å¦ä½¿ç”¨ Agent                          |
| --------------------- | ------------------------ | --------------------------------------- |
| VisualVM              | ç›‘æ§ã€åˆ†æå†…å­˜/çº¿ç¨‹      | âœ… æ˜¯ï¼ˆåŠ¨æ€ attachï¼‰                     |
| JProfiler             | æ€§èƒ½åˆ†æå·¥å…·             | âœ… æ˜¯                                    |
| Prometheus Java Agent | åº”ç”¨æŒ‡æ ‡é‡‡é›†             | âœ… æ˜¯                                    |
| SkyWalking            | å…¨é“¾è·¯è¿½è¸ª               | âœ… æ˜¯                                    |
| Arthas                | åŠ¨æ€è¯Šæ–­å·¥å…·ï¼ˆé˜¿é‡Œå¼€æºï¼‰ | âœ… æ˜¯                                    |
| ByteBuddy             | åŠ¨æ€å­—èŠ‚ç æ“ä½œåº“         | âŒ è‡ªèº«ä¸æ˜¯ agentï¼Œä½†å¸¸ä¸ agent é…åˆä½¿ç”¨ |





JProfiler æ­£æ˜¯ä½¿ç”¨äº† Java Agent æŠ€æœ¯æ¥å®ç°å¯¹è¿è¡Œä¸­ JVM çš„**æ— ä¾µå…¥å¼ç›‘æ§**ï¼Œå¹¶ä¸”å®ƒä½¿ç”¨äº†**attach æœºåˆ¶ + Instrumentation + JVMTIï¼ˆJava Virtual Machine Tool Interfaceï¼‰**çš„ç»„åˆã€‚



## ç®€æ´å›ç­”ï¼š

| åŠŸèƒ½                               | æŠ€æœ¯åŸºç¡€                             |
| ---------------------------------- | ------------------------------------ |
| **å†…å­˜ç›‘æ§ï¼ˆå¯¹è±¡åˆ†é…ã€å †å¿«ç…§ç­‰ï¼‰** | Java Agent + Instrumentation + JVMTI |
| **å¯¹è¿è¡Œä¸­ JVM çš„æ’æ¡©**            | Attach æŠ€æœ¯ï¼ˆåŠ¨æ€ attach agentï¼‰     |
| **æ–¹æ³•è€—æ—¶åˆ†æ / CPU é‡‡æ ·**        | JVMTI + Instrumentation              |
| **çº¿ç¨‹ç›‘æ§ã€é”ç«äº‰åˆ†æ**           | JVMTIï¼ˆNative å±‚è°ƒç”¨ï¼‰               |

------

## ğŸ§© å…·ä½“è§£é‡Š

### ğŸ§± JProfiler çš„æ ¸å¿ƒæœºåˆ¶åŒ…æ‹¬ï¼š

1. **åŠ¨æ€ Attach æŠ€æœ¯ï¼ˆAttach APIï¼‰**
   - ä¸éœ€è¦æå‰ç”¨ `-javaagent` å¯åŠ¨ç¨‹åº
   - é€šè¿‡ `tools.jar` ä¸­çš„ `com.sun.tools.attach.VirtualMachine` è¿æ¥ç›®æ ‡ JVM
   - åŠ¨æ€æ³¨å…¥ agentï¼Œè§¦å‘ `agentmain()` æ–¹æ³•
2. **Instrumentation APIï¼ˆJava å±‚ï¼‰**
   - ä¿®æ”¹ç±»åŠ è½½è¡Œä¸ºï¼Œå®ç°æ–¹æ³•æ’æ¡©ï¼ˆæ’å…¥é‡‡é›†æŒ‡ä»¤ï¼‰
   - ç”¨äº Java å±‚é¢ç›‘æ§æ–¹æ³•è°ƒç”¨ã€å¯¹è±¡åˆ›å»ºã€ç±»åŠ è½½ç­‰
3. **JVMTIï¼ˆC/C++ å±‚åŸç”Ÿæ¥å£ï¼‰**
   - ç”¨äºæ›´åº•å±‚çš„ç›‘æ§èƒ½åŠ›ï¼Œä¾‹å¦‚ï¼š
     - GC äº‹ä»¶ç›‘å¬
     - å¯¹è±¡åˆ†é…ç›‘æ§
     - å †è½¬å‚¨ï¼ˆHeap Dumpï¼‰
     - çº¿ç¨‹çŠ¶æ€ã€æ­»é”æ£€æµ‹
   - JProfiler å†…éƒ¨ä½¿ç”¨äº† native library ä¸ JVM äº¤äº’

------

## ğŸ“¦ JProfiler æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿï¼ˆè¿‡ç¨‹å›¾ï¼‰

```
luaå¤åˆ¶ç¼–è¾‘ç›®æ ‡ JVMï¼ˆæ­£åœ¨è¿è¡Œï¼‰ <-- Attach APIï¼ˆtools.jarï¼‰
                      |
                      +--> åŠ¨æ€åŠ è½½ JProfiler çš„ agentï¼ˆagent.jarï¼‰
                                      |
               +----------------------+
               | Instrumentation æ’æ¡©ï¼ˆJava æ–¹æ³•æ’å…¥åˆ†æé€»è¾‘ï¼‰
               | JVMTI native agentï¼ˆCå±‚ï¼Œå †åˆ†æ/å¯¹è±¡è·Ÿè¸ªï¼‰
               v
           JProfiler å®¢æˆ·ç«¯æ¥æ”¶æ•°æ®ï¼Œå›¾å½¢åŒ–å±•ç¤º
```

------

## ğŸ§  æ€»ç»“ï¼šJProfiler ç”¨äº†ä»€ä¹ˆï¼Ÿ

| æŠ€æœ¯                   | æ˜¯å¦ä½¿ç”¨  | ç”¨é€”è¯´æ˜                               |
| ---------------------- | --------- | -------------------------------------- |
| `-javaagent` é™æ€åŠ è½½  | âœ…ï¼ˆå¯é€‰ï¼‰ | å¦‚æœä½ æ„¿æ„æå‰æŒ‡å®š agentï¼Œä¹Ÿæ”¯æŒ       |
| Attach API åŠ¨æ€åŠ è½½    | âœ…ï¼ˆå¸¸ç”¨ï¼‰ | è‡ªåŠ¨ attach åˆ°è¿è¡Œä¸­çš„ JVM             |
| `Instrumentation` æ¥å£ | âœ…         | å®ç° Java å±‚æ’æ¡©                       |
| JVMTI native agent     | âœ…         | æä¾›åŸç”Ÿçº§çš„å †ã€çº¿ç¨‹ã€GCã€å¯¹è±¡è·Ÿè¸ªèƒ½åŠ› |

## ğŸš€æƒ³è‡ªå·±å®ç°ç±»ä¼¼åŠŸèƒ½æ€ä¹ˆåŠï¼Ÿ

ä½ å¯ä»¥ç”¨ä¸‹é¢ç»„åˆåšä¸€ä¸ªç®€å•ç‰ˆï¼š

| åŠŸèƒ½           | æŠ€æœ¯ç»„åˆ                     |
| -------------- | ---------------------------- |
| æ–¹æ³•ç›‘æ§       | Java Agent + ASM / ByteBuddy |
| å¯¹è±¡åˆ†é…       | JVMTI agentï¼ˆéœ€ C/C++ï¼‰      |
| åŠ¨æ€æ³¨å…¥ agent | Java Attach API              |
| çº¿ç¨‹ä¿¡æ¯é‡‡é›†   | Thread API + JVMTI           |